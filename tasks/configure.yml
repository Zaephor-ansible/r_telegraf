---
- stat:
    path: /usr/bin/nvidia-smi
  register: stat_nvidia

- name: Build inputs bundle
  when: "{{ item.when|default(true) }}"
  set_fact:
    telegraf_inputs_cfg: "{{ telegraf_inputs_cfg | default({}) | combine ({ item.input : (item.config|default([])) }) }}"
  loop:
  - { 'input': 'diskio', 'config': []  }
  - { 'input': 'kernel', 'config': []  }
  - { 'input': 'mem', 'config': []  }
  - { 'input': 'processes', 'config': []  }
  - { 'input': 'swap', 'config': []  }
  - { 'input': 'system', 'config': []  }
  - { 'input': 'iptables', 'config': []  }
  - { 'input': 'net', 'config': []  }
  - { 'input': 'netstat', 'config': []  }
  - { 'input': 'temp', 'config': []  }
  - { 'input': 'nvidia_smi', 'config': [] , 'when': stat_nvidia.stat.exists }


- name: Install config files
  become: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    force: "{{ item.force }}"
  with_items:
    - { src: 'etc_telegraf_telegraf.conf.j2', dest: '/etc/telegraf/telegraf.conf', owner: 'root', group: 'root', mode: '0644', force: 'yes' }
  register: telegraf_configfiles

- getent:
    database: group
    split: ':'
  become: yes

- name: Add additional group to user
  become: yes
  register: telegraf_usergroups
  user:
    name: "telegraf"
    groups: "{{item}}"
    append: yes
  when: item in ansible_facts.getent_group
  with_items:
  - docker

- name: "Empty variable"
  set_fact:
    telegraf_inputs_cfg: {}
